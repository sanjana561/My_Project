{% extends "base.html" %}

{% block body %}

<div id="preloader">
  <div class="spinner-logo">
    <img src="../static/assets/img/favicon.png" alt="logo" />
  </div>
  <div class="spinner"></div>
</div>

<section class="page-header">
  <div class="bg-item">
    <div class="bg-img" data-background="../static/assets/img/bg-img/page-header-bg.png"></div>
    <div class="overlay"></div>
    <div class="shapes">
      <div class="shape shape-1"><img src="../static/assets/img/shapes/page-header-shape-1.png" alt="shape" /></div>
      <div class="shape shape-2"><img src="../static/assets/img/shapes/page-header-shape-2.png" alt="shape" /></div>
      <div class="shape shape-3"><img src="../static/assets/img/shapes/page-header-shape-3.png" alt="shape" /></div>
    </div>
  </div>
  <div class="container">
    <div class="page-header-content text-center">
      <h1 class="title">Check Attendance</h1>
      <h4 class="sub-title">
        <a class="home" href="/">Home</a> <span class="icon"> / </span>
        <a class="inner-page" href="#">Attendance</a>
      </h4>
    </div>
  </div>
</section>

<section class="contact-section pt-120 pb-120">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8 col-md-10">
        <div class="blog-contact-form contact-form">
          <h2 class="title mb-0">Student Attendance Portal</h2>
          <p class="mb-30 mt-10">Enter your Student ID to check your attendance across all classes.</p>

          <div class="request-form">
            <form id="attendanceForm" class="form-horizontal">
              <div class="form-group row">
                <div class="col-md-12">
                  <div class="form-item">
                    <input
                      type="text"
                      id="student_id"
                      name="student_id"
                      class="form-control"
                      placeholder="Enter Student ID"
                      required
                    />
                    <div class="icon"><i class="fa-solid fa-id-card"></i></div>
                  </div>
                </div>
              </div>

              <div class="submit-btn">
                <button id="checkAttendanceBtn" class="ed-primary-btn" type="submit" style="background-color: #07a698">
                  Check Attendance
                </button>
              </div>
            </form>

            <!-- ✅ Table for displaying results -->
            <div id="attendanceResult" class="mt-4" style="display: none">
              <div class="card shadow p-4 rounded-3" style="background: #f8f9fa">
                <h4 class="text-center mb-3" style="color: #07a698">Attendance Summary</h4>
                <p><strong>Student ID:</strong> <span id="result_id"></span></p>
                <p><strong>Student Name:</strong> <span id="result_name"></span></p>

                <h5 class="mt-3" style="color: #07a698">Overall Summary</h5>
                <p>
                  <strong>Total Sessions:</strong> <span id="overall_total"></span>,
                  <strong>Present:</strong> <span id="overall_present"></span>,
                  <strong>Absent:</strong> <span id="overall_absent"></span>,
                  <strong>Subject:</strong> <span id="overall_subject"></span>,
                  <strong>Period:</strong> <span id="overall_period"></span>,
                  <strong>AttendenceTakenBy:</strong> <span id="overall_attendenceTaken"></span>,

                  <strong>Attendance %:</strong> <span id="overall_percent"></span>%
                </p>

                <div class="table-responsive mt-3">
                  <table class="table table-striped table-bordered">
                    <thead style="background-color: #07a698; color: white;">
                      <tr>
                        <th>Class Name</th>
                        <th>Total Sessions</th>
                        <th>Present</th>
                        <th>Absent</th>
                        <th>Subject</th>
                        <th>Period</th>
                        <th>Attendance Taken By</th>              
                        <th>Attendance %</th>
                      </tr>
                    </thead>
                    <tbody id="attendanceTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
            <!-- End of Results -->
          </div>
        </div>
      </div>
    </div>
  </div>
</section>


<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("attendanceForm");
  const resultDiv = document.getElementById("attendanceResult");
  const tableBody = document.getElementById("attendanceTableBody");

  form.addEventListener("submit", async function (e) {
    e.preventDefault();

    const student_id = document.getElementById("student_id").value.trim();

    if (!student_id) {
      Swal.fire({
        icon: "warning",
        title: "Missing Information",
        text: "Please enter your Student ID.",
      });
      return;
    }

    try {
      const response = await fetch(`/api/check_attendance`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ student_id })
      });
      const data = await response.json();

      if (response.ok) {
        Swal.fire({
          icon: "success",
          title: "Attendance Retrieved",
          text: "Your attendance summary is displayed below.",
          showConfirmButton: false,
          timer: 1500,
        });

        document.getElementById("result_id").textContent = data.student_id;
        document.getElementById("result_name").textContent = data.student_name;

        // Overall summary - ONLY displays aggregated counts
        document.getElementById("overall_total").textContent = data.overall_summary.total_days;
        document.getElementById("overall_present").textContent = data.overall_summary.present_days;
        document.getElementById("overall_absent").textContent = data.overall_summary.absent_days;
        
        // --- START CORRECTION: Hide subject/period/teacher elements ---
        document.getElementById("overall_subject").parentElement.style.display = 'none';
        document.getElementById("overall_period").parentElement.style.display = 'none';
        document.getElementById("overall_attendenceTaken").parentElement.style.display = 'none';
        // --- END CORRECTION ---

        document.getElementById("overall_percent").textContent = data.overall_summary.attendance_percentage;

        // Clear old rows
        tableBody.innerHTML = "";

        // Add class-wise rows
        data.class_wise_summary.forEach(cls => {
          // The key is 'teacher_name' from the backend, not 'attendence'
          const teacherName = cls.teacher_name || 'N/A';
          
          const row = `
            <tr>
              <td>${cls.class_name}</td>
              <td>${cls.total_days}</td>
              <td>${cls.present_days}</td>
              <td>${cls.absent_days}</td>
              <td>${cls.subject}</td>
              <td>${cls.period}</td>
              <td>${teacherName}</td>       
              <td>${cls.attendance_percentage}%</td>
            </tr>`;
          tableBody.insertAdjacentHTML("beforeend", row);
        });

        resultDiv.style.display = "block";
      } else {
        Swal.fire({
          icon: "error",
          title: "No Record Found",
          text: data.error || "No attendance data found for this Student ID.",
        });
        resultDiv.style.display = "none";
      }
    } catch (error) {
      console.error("Error fetching attendance:", error);
      Swal.fire({
        icon: "error",
        title: "Error",
        text: "An unexpected error occurred. Please try again later.",
      });
    }
  });
});
</script>

{% endblock body %}
