{% extends "base-home.html" %}

{% block body %}

<style>
    #attendance-summary-wrapper {
        width: 100%;
    }

    #attendance-summary-wrapper table {
        width: 100%;
        border-collapse: collapse;
        page-break-inside: auto;
    }

    #attendance-summary-wrapper tr {
        page-break-inside: avoid;
        page-break-after: auto;
    }

    #attendance-summary-wrapper thead {
        display: table-header-group; /* repeat header on each page */
    }
</style>
<link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/duotone/style.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<main>
    <div class="container-fluid">
        <div class="row m-1">
            <div class="col-12">
                <h4 class="main-title">Track Attendance</h4>
                <ul class="app-line-breadcrumbs mb-3">
                    <li>
                        <a class="f-s-14 f-w-500" href="{{ url_for('dashboard') }}">
                            <span><i class="ph-duotone ph-house f-s-16"></i> Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a class="f-s-14 f-w-500" href="{{ url_for('get_all_classes') }}">
                            Attendance
                        </a>
                    </li>
                    <li class="active">
                        <a class="f-s-14 f-w-500" href="#">Track Attendance</a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Attendance Records</h5>

                           <div class="d-flex justify-content-end mb-3">
    <button id="download-pdf-btn" class="btn btn-success">
        <i class="fas fa-file-pdf"></i> Download PDF
    </button>
</div>

                    </div>
                    <div class="card-body p-3">
                        <div class="row g-3 align-items-end mb-4">
                            <div class="col-md-3">
                                <label for="attendance-class-select" class="form-label">Select Class</label>
                                <select id="attendance-class-select" class="form-select">
                                    <option disabled selected>Loading classes...</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="attendance-period-filter" class="form-label">Period (e.g., 1)</label>
                                <input type="text" id="attendance-period-filter" class="form-control" placeholder="Optional" />
                            </div>
                            <div class="col-md-2">
                                <label for="attendance-subject-filter" class="form-label">Subject</label>
                                <input type="text" id="attendance-subject-filter" class="form-control" placeholder="Optional" />
                            </div>
                            <div class="col-md-2">
                                <label for="attendance-start-date" class="form-label">Start Date</label>
                                <input type="date" id="attendance-start-date" class="form-control" />
                            </div>
                            <div class="col-md-2">
                                <label for="attendance-end-date" class="form-label">End Date</label>
                                <input type="date" id="attendance-end-date" class="form-control" />
                            </div>
                            <div class="col-md-1 d-grid">
                                <button id="attendance-filter-btn" class="btn btn-primary">Filter</button>
                            </div>
                        </div>
                        <div id="attendance-summary-wrapper">
    <div id="attendance-report-header" class="mb-3 fw-semibold fs-5"></div>
    <div class="table-responsive">
        <table id="attendance-report-table" class="table table-striped">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Student Name</th>
                    <th>Status</th>
                    <th>Period</th>
                    <th>Subject</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="6" class="text-center">Select class and filter to load attendance data.</td></tr>
            </tbody>
        </table>
    </div>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>

</main>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const token = localStorage.getItem("jwt_token");
    if (!token) {
        Swal.fire("Error", "You must login first", "error").then(() => {
            window.location.href = "{{ url_for('login') }}";
        });
        return;
    }

    const classSelect = document.getElementById("attendance-class-select");
    const startDate = document.getElementById("attendance-start-date");
    const endDate = document.getElementById("attendance-end-date");
    // 1. Get new filter elements
    const periodFilter = document.getElementById("attendance-period-filter");
    const subjectFilter = document.getElementById("attendance-subject-filter");
    
    const filterBtn = document.getElementById("attendance-filter-btn");
    const reportHeader = document.getElementById("attendance-report-header");
    const reportTableBody = document.querySelector("#attendance-report-table tbody");

    let selectedClassId = null;
    let selectedClassName = "";


    const pdfBtn = document.getElementById("download-pdf-btn");

    pdfBtn.addEventListener("click", () => {
        if (!selectedClassId) {
            Swal.fire("Warning", "Please select a class first", "warning");
            return;
        }

        const element = document.getElementById("attendance-summary-wrapper");
        const opt = {
            margin:       0.3,
            filename:     `Attendance_Report_${selectedClassName || 'class'}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, scrollY: 0 },
            // Changed orientation to portrait for better readability with 6 columns
            jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' } 
        };

        html2pdf().set(opt).from(element).save();
    });


    async function loadClasses() {
        try {
            const res = await fetch("/api/classes", {
                headers: { Authorization: "Bearer " + token },
            });
            if (!res.ok) throw new Error("Failed to load classes");
            const data = await res.json();
            classSelect.innerHTML = '<option disabled selected>Select class</option>';
            data.classes.forEach(cls => {
                const option = document.createElement("option");
                option.value = cls.id;
                option.text = cls.name;
                classSelect.appendChild(option);
            });
        } catch (err) {
            Swal.fire("Error", err.message, "error");
            classSelect.innerHTML = '<option disabled>Error loading classes</option>';
        }
    }

    async function fetchAttendance() {
        if (!selectedClassId) {
            // Updated colspan to 6
            reportTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Select class to view attendance.</td></tr>';
            reportHeader.textContent = "";
            return;
        }

        let params = new URLSearchParams();
        if (startDate.value) params.append("start_date", startDate.value);
        if (endDate.value) params.append("end_date", endDate.value);
        
        // 2. Add period and subject to URL parameters
        if (periodFilter.value) params.append("period", periodFilter.value);
        if (subjectFilter.value) params.append("subject", subjectFilter.value);


        const url = `/api/classes/${selectedClassId}/attendance?${params.toString()}`;
        reportHeader.textContent = `Attendance Report for: ${selectedClassName}`;
        // Updated colspan to 6
        reportTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Loading...</td></tr>';

        try {
            const res = await fetch(url, {
                headers: { Authorization: "Bearer " + token },
            });
            if (!res.ok) {
                let errorMsg = "Failed to fetch attendance";
                try {
                    const errData = await res.json();
                    if (errData.error) errorMsg = errData.error;
                } catch {}
                throw new Error(errorMsg);
            }
            const data = await res.json();
            if (!data.attendance_records?.length) {
                // Updated colspan to 6
                reportTableBody.innerHTML = '<tr><td colspan="6" class="text-center">No attendance records found.</td></tr>';
                return;
            }
 
            reportTableBody.innerHTML = "";
            data.attendance_records.forEach(rec => {
                const dateStr = new Date(rec.date).toLocaleDateString();
                let timeStr = "";
                if(rec.time){
                    if(typeof rec.time === "string"){
                        timeStr = rec.time.length > 5 ? rec.time.substr(0,5) : rec.time;
                    } else {
                        // This time parsing logic is complex and might be simplified if the backend always returns a HH:MM:SS string
                        timeStr = new Date(`1970-01-01T${rec.time}Z`).toISOString().substr(11,5);
                    }
                }
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${timeStr}</td>
                    <td>${rec.student_name}</td>
                    <td>${rec.status}</td>
                    <td>${rec.period || '-'}</td>
                    <td>${rec.subject || '-'}</td>
                `;
                reportTableBody.appendChild(tr);
            });
        } catch (err) {
            // Updated colspan to 6
            reportTableBody.innerHTML = `<tr><td colspan="6" class="text-danger text-center">${err.message}</td></tr>`;
            Swal.fire("Error", err.message, "error");
        }
    }

    classSelect.addEventListener("change", () => {
        selectedClassId = classSelect.value;
        selectedClassName = classSelect.options[classSelect.selectedIndex].text;
        fetchAttendance();
    });

    filterBtn.addEventListener("click", fetchAttendance);

    loadClasses();
});
</script>

{% endblock %}