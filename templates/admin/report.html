{% extends "base-home.html" %}

{% block body %}

<style>
    /* ... (CSS remains the same) ... */
    #attendance-summary-wrapper {
    width: 100%;
}

#attendance-summary-wrapper table {
    width: 100%;
    border-collapse: collapse;
    page-break-inside: auto;
}

#attendance-summary-wrapper tr {
    page-break-inside: avoid;
    page-break-after: auto;
}

#attendance-summary-wrapper thead {
    display: table-header-group; /* repeat header on each page */
}

#attendance-summary-wrapper tfoot {
    display: table-footer-group;
}

</style>
<link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/duotone/style.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<main>
    <div class="container-fluid">
        <div class="row m-1">
            <div class="col-12">
                <h4 class="main-title">Detailed Attendance Report</h4>
                <ul class="app-line-breadcrumbs mb-3">
                    <li>
                        <a class="f-s-14 f-w-500" href="{{ url_for('dashboard') }}">
                            <span><i class="ph-duotone ph-house f-s-16"></i> Dashboard</span>
                        </a>
                    </li>
                    <li class="active">
                        <a class="f-s-14 f-w-500" href="#">Detailed Report</a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 id="report-class-title">Attendance Records</h5>
                        <button id="download-pdf-btn" class="btn btn-success">
                            <i class="fas fa-file-pdf"></i> Download PDF
                        </button>
                    </div>
                    <div class="card-body p-3">
                        <div class="row g-3 align-items-end mb-4">
                            <div class="col-md-3">
                                <label for="report-class-select" class="form-label">Select Class</label>
                                <select id="report-class-select" class="form-select">
                                    <option disabled selected>Loading classes...</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="report-start-date" class="form-label">Start Date</label>
                                <input type="date" id="report-start-date" class="form-control" />
                            </div>
                            <div class="col-md-3">
                                <label for="report-end-date" class="form-label">End Date</label>
                                <input type="date" id="report-end-date" class="form-control" />
                            </div>
                            <div class="col-md-3 d-grid">
                                <button id="report-filter-btn" class="btn btn-primary">Load Report</button>
                            </div>
                        </div>

                        <div id="attendance-report-wrapper">
                            <p id="report-teacher-name" class="fw-semibold">Teacher: ---</p>
                            <div class="table-responsive">
                                <table id="detailed-attendance-table" class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Time</th>
                                            <th>Student Name</th>
                                            <th>Subject</th>
                                            <th>Period</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report-table-body">
                                        <tr><td colspan="6" class="text-center">Select class and date range to load detailed report.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="report-meta" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const token = localStorage.getItem("jwt_token");
    if (!token) {
        Swal.fire("Error", "You must login first", "error").then(() => {
            window.location.href = "{{ url_for('login') }}";
        });
        return;
    }

    // References
    const classSelect = document.getElementById("report-class-select");
    const startDate = document.getElementById("report-start-date");
    const endDate = document.getElementById("report-end-date");
    const filterBtn = document.getElementById("report-filter-btn");
    const tableBody = document.getElementById("report-table-body");
    const reportTitle = document.getElementById("report-class-title");
    const teacherNameDisplay = document.getElementById("report-teacher-name");
    const COLSPAN_COUNT = 6;
    
    let selectedClassId = null;
    let selectedClassName = "";


    // --- 1. Load Classes ---
    async function loadClasses() {
        try {
            const res = await fetch("/api/classes", {
                headers: { Authorization: "Bearer " + token },
            });
            if (!res.ok) throw new Error("Failed to load classes");
            const data = await res.json();
            classSelect.innerHTML = '<option disabled selected>Select class</option>';
            data.classes.forEach(cls => {
                const option = document.createElement("option");
                option.value = cls.id;
                option.text = cls.name;
                classSelect.appendChild(option);
            });
        } catch (err) {
            Swal.fire("Error", err.message, "error");
            classSelect.innerHTML = '<option disabled>Error loading classes</option>';
        }
    }


    // --- 2. Fetch Detailed Report ---
    async function fetchDetailedReport() {
        if (!selectedClassId) {
            tableBody.innerHTML = `<tr><td colspan="${COLSPAN_COUNT}" class="text-center">Select class and date range to load report.</td></tr>`;
            reportTitle.textContent = "Attendance Records";
            teacherNameDisplay.textContent = "Teacher: ---";
            return;
        }

        let params = new URLSearchParams();
        if (startDate.value) params.append("start_date", startDate.value);
        if (endDate.value) params.append("end_date", endDate.value);

        const url = `/api/classes/${selectedClassId}/attendance?${params.toString()}`;
        reportTitle.textContent = `Detailed Report for: ${selectedClassName}`;
        tableBody.innerHTML = `<tr><td colspan="${COLSPAN_COUNT}" class="text-center">Loading...</td></tr>`;
        teacherNameDisplay.textContent = "Teacher: Loading...";

        try {
            const res = await fetch(url, {
                headers: { Authorization: "Bearer " + token },
            });
            if (!res.ok) {
                let errorMsg = "Failed to fetch detailed report";
                try {
                    const errData = await res.json();
                    if (errData.error) errorMsg = errData.error;
                } catch {}
                throw new Error(errorMsg);
            }
            const data = await res.json();
            
            tableBody.innerHTML = "";
            
            // Update Teacher Name Display
            teacherNameDisplay.innerHTML = `Teacher: <strong>${data.teacher_name || 'N/A'}</strong>`;

            if (!data.attendance_records || data.attendance_records.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${COLSPAN_COUNT}" class="text-center">No attendance records found for the selected criteria.</td></tr>`;
                return;
            }
            
            data.attendance_records.forEach(record => {
                const statusClass = record.status.toLowerCase() === 'present' ? 'text-success' : 'text-danger';
                
                tableBody.innerHTML += `
                    <tr>
                        <td>${record.date}</td>
                        <td>${record.time}</td>
                        <td>${record.student_name}</td>
                        <td>${record.subject || 'N/A'}</td>
                        <td>${record.period || 'N/A'}</td>
                        <td class="${statusClass} fw-semibold">${record.status}</td>
                    </tr>
                `;
            });

        } catch (err) {
            tableBody.innerHTML = `<tr><td colspan="${COLSPAN_COUNT}" class="text-danger text-center">${err.message}</td></tr>`;
            teacherNameDisplay.textContent = "Teacher: Error";
            Swal.fire("Error", err.message, "error");
        }
    }


    // --- 3. Event Listeners and PDF ---
    classSelect.addEventListener("change", () => {
        selectedClassId = classSelect.value;
        selectedClassName = classSelect.options[classSelect.selectedIndex].text;
        fetchDetailedReport(); // Load report when class changes
    });

    filterBtn.addEventListener("click", fetchDetailedReport); // Load report when filter button is clicked

    // PDF Download Logic
    document.getElementById("download-pdf-btn").addEventListener("click", () => {
        if (!selectedClassId) {
            Swal.fire("Warning", "Please select a class and load the report first.", "warning");
            return;
        }

        const element = document.getElementById("attendance-report-wrapper");
        
        const opt = {
            margin:       0.3,
            filename:     `Detailed_Attendance_Report_${selectedClassName || 'class'}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, scrollY: 0 }, 
            jsPDF:        { unit: 'in', format: 'a4', orientation: 'landscape' }
        };

        html2pdf().set(opt).from(element).save();
    });

    // Initialization
    loadClasses();
});
</script>
{% endblock %}